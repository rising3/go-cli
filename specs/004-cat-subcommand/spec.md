# Feature Specification: Cat サブコマンド実装

**Feature Branch**: `004-cat-subcommand`  
**Created**: 2025-11-30  
**Status**: Draft  
**Input**: User description: "cobra-cliを使用してcatサブコマンドを追加実装する。catサブコマンドは、unixのcatコマンドのクローンとし、代表的なオプションをサポートする仕様とする。integration_testも作成する。"

## Clarifications

### Session 2025-11-30

- Q: 行番号フォーマットの桁数 → A: 6桁固定（999,999行を超えても6桁に収める、桁あふれは許容）
- Q: 制御文字変換の具体的範囲 → A: ASCII 0-31（タブ・改行除く）と127（DEL）を対象
- Q: ストリーム処理のバッファサイズ → A: 32KB（標準的、バランス重視）
- Q: 複数エラー時の終了コード判定 → A: 1つでもエラーがあれば終了コード1（部分的成功も失敗扱い）
- Q: 行番号が999,999を超えた場合の動作 → A: 桁あふれ時は最下位6桁のみ表示

## User Scenarios & Testing *(mandatory)*

### User Story 1 - ファイル内容の基本表示 (Priority: P1)

開発者がファイルの内容を標準出力に表示したい。ファイルパスを引数として渡すと、そのファイルの全内容が標準出力に出力される。複数ファイルを指定した場合は順番に連結して出力される。

**Why this priority**: catコマンドの最も基本的で頻繁に使用される機能であり、これがなければcatコマンドとして機能しない。ファイル内容の確認、ログの表示、パイプラインでのデータ処理に必須。

**Independent Test**: `mycli cat testfile.txt` を実行してファイル内容が標準出力に表示されることで完全にテスト可能。他の機能に依存しない独立したMVP。

**Acceptance Scenarios**:

1. **Given** `test.txt` に "Hello World" が書かれている、**When** `mycli cat test.txt` を実行、**Then** 標準出力に `Hello World` が出力される
2. **Given** `file1.txt` に "First" 、`file2.txt` に "Second" が書かれている、**When** `mycli cat file1.txt file2.txt` を実行、**Then** 標準出力に `FirstSecond` が連結して出力される
3. **Given** 複数行のファイル `multi.txt` がある、**When** `mycli cat multi.txt` を実行、**Then** すべての行が元の順序で改行を保持して出力される
4. **Given** 空ファイル `empty.txt` がある、**When** `mycli cat empty.txt` を実行、**Then** 何も出力されない（エラーも出さない）

---

### User Story 2 - 標準入力からの読み込み (Priority: P2)

開発者が標準入力からデータを読み込んで出力したい。ファイル引数が指定されない場合、またはファイル名として `-` が指定された場合、標準入力から読み込む。

**Why this priority**: パイプラインでのデータ処理に不可欠。他のコマンドの出力を処理したり、リダイレクトされた入力を扱う標準的なUNIXの使用パターン。

**Independent Test**: `echo "test" | mycli cat` を実行して標準入力からの読み込みが機能することで独立してテスト可能。基本出力機能（P1）があれば追加実装できる。

**Acceptance Scenarios**:

1. **Given** CLIツールがインストールされている、**When** `mycli cat` を引数なしで実行し標準入力に "Hello" を入力、**Then** 標準出力に `Hello` が出力される
2. **Given** CLIツールがインストールされている、**When** `echo "test" | mycli cat` を実行、**Then** `test` が標準出力に出力される
3. **Given** `file.txt` に "File" が書かれている、**When** `echo "Stdin" | mycli cat - file.txt` を実行、**Then** `Stdin` の後に `File` が出力される（`-` が標準入力を表す）
4. **Given** `file.txt` に "File" が書かれている、**When** `mycli cat file.txt - file.txt` を実行し標準入力に "Mid" を入力、**Then** `File`, `Mid`, `File` の順で出力される

---

### User Story 3 - 行番号表示オプション (-n) (Priority: P3)

開発者がファイルの各行に行番号を付けて表示したい。`-n` オプションを使用すると、すべての行（空行を含む）の先頭に行番号が付加される。

**Why this priority**: コードレビュー、ログ解析、デバッグ時に行番号が必要な場面で便利。ただし、基本的な表示機能があれば代替手段（行番号付きエディタで開く）も可能なため優先度は中程度。

**Independent Test**: `mycli cat -n test.txt` を実行して各行に行番号が付加されることで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** `test.txt` に3行のテキストがある、**When** `mycli cat -n test.txt` を実行、**Then** 各行の先頭に "     1  ", "     2  ", "     3  " のような形式で行番号が付加される
2. **Given** `test.txt` に空行を含む5行がある、**When** `mycli cat -n test.txt` を実行、**Then** 空行にも行番号が付加される
3. **Given** 複数ファイル `file1.txt`, `file2.txt` がある、**When** `mycli cat -n file1.txt file2.txt` を実行、**Then** 連続した行番号が両方のファイルに付加される（2つ目のファイルは1つ目の続きから番号が始まる）

---

### User Story 4 - 空行スキップ行番号表示 (-b) (Priority: P4)

開発者が空行を除いた行にのみ行番号を表示したい。`-b` オプションを使用すると、空行以外の行にのみ行番号が付加される。

**Why this priority**: `-n` オプションの補完機能であり、空行の多いファイルで実質的な内容行のみをカウントしたい場合に便利。使用頻度は `-n` より低い。

**Independent Test**: `mycli cat -b test.txt` を実行して空行以外に行番号が付加されることで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** `test.txt` に "Line1", 空行, "Line2", 空行, "Line3" がある、**When** `mycli cat -b test.txt` を実行、**Then** "Line1", "Line2", "Line3" のみに行番号 1, 2, 3 が付加され、空行には番号が付かない
2. **Given** 完全に空のファイルがある、**When** `mycli cat -b empty.txt` を実行、**Then** 何も出力されない

---

### User Story 5 - 行末表示オプション (-E) (Priority: P4)

開発者が各行の末尾に `$` 記号を表示したい。`-E` オプションを使用すると、各行の改行文字の直前に `$` が表示される。

**Why this priority**: 行末の空白文字や改行の有無を確認する際に便利。主にデバッグや品質チェック目的で使用される特殊な機能。

**Independent Test**: `mycli cat -E test.txt` を実行して各行末に `$` が付加されることで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** `test.txt` に "Hello" という1行がある、**When** `mycli cat -E test.txt` を実行、**Then** `Hello$` と表示される
2. **Given** `test.txt` に "Line1", "Line2" の2行がある、**When** `mycli cat -E test.txt` を実行、**Then** `Line1$` と `Line2$` が各行に表示される
3. **Given** 行末に空白があるファイルがある、**When** `mycli cat -E test.txt` を実行、**Then** 空白の後に `$` が表示されるため、行末空白が視覚的に確認できる

---

### User Story 6 - タブ文字表示オプション (-T) (Priority: P5)

開発者がタブ文字を `^I` として表示したい。`-T` オプションを使用すると、すべてのタブ文字が `^I` に置換されて表示される。

**Why this priority**: タブとスペースの混在を確認する際に便利。コーディング標準チェックやフォーマット検証で使用されるが、専用ツール（linter）の方が一般的。

**Independent Test**: `mycli cat -T test.txt` を実行してタブが `^I` として表示されることで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** `test.txt` に "Col1\tCol2" （\tはタブ文字）がある、**When** `mycli cat -T test.txt` を実行、**Then** `Col1^ICol2` と表示される
2. **Given** `test.txt` に複数のタブが連続している、**When** `mycli cat -T test.txt` を実行、**Then** 各タブが `^I` として表示される

---

### User Story 7 - 非表示文字表示オプション (-v) (Priority: P5)

開発者が制御文字を可視化したい。`-v` オプションを使用すると、タブと改行以外の非表示文字が `^` 記法で表示される。

**Why this priority**: バイナリデータや制御文字を含むファイルのデバッグに便利だが、通常のテキストファイル操作では不要。専門的な用途。

**Independent Test**: 制御文字を含むファイルで `mycli cat -v test.txt` を実行して制御文字が可視化されることで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** `test.txt` に制御文字 (ASCII 7 ベル) が含まれる、**When** `mycli cat -v test.txt` を実行、**Then** `^G` と表示される
2. **Given** `test.txt` に通常のテキストのみがある、**When** `mycli cat -v test.txt` を実行、**Then** 通常の出力と同じ（制御文字がないため）

---

### User Story 8 - 複数オプション組み合わせ (-A = -vET) (Priority: P5)

開発者がすべての非表示文字、タブ、行末を一度に可視化したい。`-A` オプションは `-v`, `-E`, `-T` の組み合わせと同等。

**Why this priority**: ファイルのフォーマット問題を包括的に診断する際に便利だが、個別オプションで対応可能。利便性向上のショートカット。

**Independent Test**: `mycli cat -A test.txt` を実行してすべての非表示文字が可視化されることで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** `test.txt` に "Hello\tWorld" と改行がある、**When** `mycli cat -A test.txt` を実行、**Then** `Hello^IWorld$` と表示される
2. **Given** `-A` と個別オプション `-v -E -T` を別々に実行、**When** 両方の出力を比較、**Then** 同じ結果が得られる

---

### Edge Cases

- **存在しないファイルを指定**: `mycli cat nonexistent.txt` → エラーメッセージ "cat: nonexistent.txt: No such file or directory" をstderrに出力し、終了コード1で終了
- **読み取り権限がないファイル**: エラーメッセージ "cat: file.txt: Permission denied" をstderrに出力し、終了コード1で終了
- **ディレクトリを指定**: `mycli cat /path/to/dir` → エラーメッセージ "cat: /path/to/dir: Is a directory" をstderrに出力し、終了コード1で終了
- **複数ファイルの一部がエラー**: `mycli cat good.txt bad.txt good2.txt` → エラーのあるファイルはstderrにエラー出力し、他の有効なファイルは標準出力に出力。最終的に終了コード1で終了
- **巨大ファイル（GB単位）**: メモリに全体を読み込まず、バッファリングしてストリーム処理することでメモリ効率を保つ
- **バイナリファイル**: テキストファイルと同様に出力するが、`-v` オプションで制御文字が可視化される
- **空の標準入力**: `mycli cat < /dev/null` → 何も出力せず正常終了（終了コード0）
- **無効なオプション指定**: `mycli cat -x file.txt` → エラーメッセージ "unknown flag: -x" をstderrに出力し、ヘルプメッセージを表示後、終了コード1で終了
- **オプションの競合**: `-n` と `-b` が両方指定された場合、後に指定された方を優先する（POSIX標準動作）
- **UTF-8以外のエンコーディング**: 入力ファイルのエンコーディングは自動検出せず、バイト列をそのまま出力（Go標準の動作）
- **999,999行を超えるファイル**: `-n` または `-b` オプション使用時、行番号が999,999を超えた場合は最下位6桁のみ表示（例: 1,000,000行目は "000000  "、1,234,567行目は "234567  "）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: `mycli cat` コマンドは、引数として渡されたファイルパスのファイル内容を標準出力に出力しなければならない
- **FR-002**: 複数のファイルが指定された場合、指定された順序で連結して出力しなければならない
- **FR-003**: ファイル引数が指定されない場合、標準入力から読み込んで標準出力に出力しなければならない
- **FR-004**: ファイル引数として `-` が指定された場合、そのタイミングで標準入力から読み込まなければならない
- **FR-005**: `-n` オプションが指定された場合、すべての行（空行を含む）の先頭に行番号を付加しなければならない。行番号の形式は右揃え6桁 + 2つのスペース（例: "     1  "）とする。999,999行を超えた場合は最下位6桁のみ表示する
- **FR-006**: `-b` オプションが指定された場合、空行以外の行にのみ行番号を付加しなければならない。行番号の形式は `-n` と同じとする
- **FR-007**: `-n` と `-b` が両方指定された場合、後に指定された方を優先しなければならない
- **FR-008**: `-E` オプションが指定された場合、各行の末尾（改行文字の直前）に `$` 記号を表示しなければならない
- **FR-009**: `-T` オプションが指定された場合、すべてのタブ文字を `^I` として表示しなければならない
- **FR-010**: `-v` オプションが指定された場合、ASCII 0-31（タブ9と改行10を除く）およびASCII 127（DEL）の制御文字を `^` 記法で表示しなければならない（例: ASCII 7 → `^G`、ASCII 127 → `^?`）
- **FR-011**: `-A` オプションが指定された場合、`-v -E -T` を指定したのと同じ動作をしなければならない
- **FR-012**: 複数のオプション（`-n`, `-E`, `-T` など）を同時に指定可能でなければならない
- **FR-013**: 存在しないファイル、読み取り権限のないファイル、ディレクトリが指定された場合、適切なエラーメッセージをstderrに出力し、終了コード1で終了しなければならない
- **FR-014**: 複数ファイルの一部がエラーの場合、エラーのあるファイルはスキップしてstderrにエラー出力し、他のファイルは処理を継続しなければならない。1つでもエラーが発生した場合は、最終的に終了コード1で終了する（部分的成功も失敗として扱う）
- **FR-015**: エラーは標準エラー出力（stderr）に出力し、標準出力（stdout）は正常なファイル内容のみに使用しなければならない
- **FR-016**: コマンドのヘルプメッセージ（`mycli cat --help`）は、簡潔な説明、主要オプション、2-3個の基本的な使用例を明確に示さなければならない
- **FR-017**: 巨大ファイル（GB単位）でもメモリに全体を読み込まず、32KBのバッファサイズでストリーム処理しなければならない
- **FR-018**: バイナリファイルもテキストファイルと同様に出力しなければならない（バイト列をそのまま出力）

### Key Entities

- **ファイル**: 読み込み対象のテキストまたはバイナリファイル。パスで識別され、存在性と読み取り権限が検証される
- **標準入力 (stdin)**: ファイル引数がない場合、または `-` が指定された場合に読み込むデータソース
- **標準出力 (stdout)**: ファイル内容の出力先。正常な処理結果のみが出力される
- **標準エラー出力 (stderr)**: エラーメッセージの出力先。ファイルエラー、無効なオプションなどが出力される

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーが `mycli cat file.txt` を実行すると、100ms以内（ファイルサイズ1MB以下の場合）に標準出力に結果が表示される
- **SC-002**: 1GBのファイルを処理する際、メモリ使用量が100MB以下に抑えられる（ストリーム処理により）
- **SC-003**: UNIX標準の `cat` コマンドと同じ引数を渡したとき、同じ出力結果が得られる（互換性）
- **SC-004**: `mycli cat --help` を実行すると、50ms以内に簡潔で明確なヘルプメッセージ（説明、オプション、2-3個の使用例を含む）が表示される
- **SC-005**: 存在しないファイルを指定した場合、適切なエラーメッセージがstderrに出力され、終了コード1で終了する
- **SC-006**: `-n`, `-b`, `-E`, `-T`, `-v`, `-A` の各オプションが正しく機能し、期待される出力形式が得られる
- **SC-007**: すべての機能要件が自動テストでカバーされ、テストが成功する
- **SC-008**: 実際のファイルI/Oを含む統合テストが実行可能であり、すべてのユーザーシナリオが検証される
- **SC-009**: 複数ファイルを指定した場合、正しい順序で連結された結果が得られる
- **SC-010**: 標準入力からの読み込み（パイプラインでの使用）が正しく機能する
